
## TCP协议

### 背景
* 衡量Web页面性能的一个重要指标叫做"FP(First Paint)",就是从页面加载到首次开始绘制的时长
* 影响FP的一个重要因素就是网络加载速度
* 想要优化网络加载速度，那么就需要对网络协议有了解，无论是使用HTPP,HTTPS,还是WebSocket,`都是基于TCP/IP协议的`
* 所以我们需要先了解TCP/IP协议是怎么工作的

### 一个数据包的旅程
* `在网络中，一个文件通常会被拆分为很多数据包进行传输`，而数据包在传输过程中又有很大概率会丢失或者出错
* 那么要怎么样保证文件能够完整的送达到浏览器端呢？
* 举个例子，在下载视频的时候，可以看到不一定是完全按照数据包顺序进行下载的，点击边看边播还是可以观看其他位置已下载数据包的内容。
    
* 下面将按照`"数据包如何送达主机","主机如何将数据包送达应用","数据包是如何完整地送达应用"`三个角度讲述数据包的传输过程
    
#### 1. IP协议:将数据包送达目的主机
* 数据包要在互联网上进行传输，就必须要符合`网际协议IP(Internet Protocol)协议标准`
* 互联网上的每个在线设备都有一个唯一的地址，这个地址就是一个数字，类似于我们的家庭地址一样，独一无二。
* 而`计算机的地址就被称为IP地址，实际上我们访问任意一个网站都是我们的计算机去向另一台计算机请求信息。`
    
* 如要主机A想把数据包传输到主机B,那么在传输之前，数据包上就要附加主机B的IP地址，才能够在互联网中找到主机B
* 因为主机A需要主机B返回信息给自己，所以数据包还需要附加主机A自身的IP地址，然后主机B才能返回信息给主机A
* `这些附加的IP地址都会被装进一个叫做IP头的数据结构里面。`
* IP头是IP数据包开头的信息，包括IP版本，源IP地址，目标IP地址，生存时间等信息
* 这个过程可以看下面的模型:

    
#### 2. UDP协议:把数据包送达到应用程序
* IP协议只能把数据包发送到目标主机，但是数据包应该发送到微信还是QQ?
* 因此就需要基于IP协议之上开发能够和应用程序打交道的协议，最常见的就是`用户数据包协议UDP(Uer Datagram Protocol)`
    
* UDP中一个最重要的信息是`端口号`,也就是`每个访问网络的应用程序都必须绑定一个端口号`
* 通过端口号，UDP协议就能把指定的数据包发送给指定的应用程序了
* 所以`IP协议通过IP地址把数据包发送给目标主机，而UDP协议通过端口号把数据包发送给目标应用程序`
* 和IP头一样，`端口号会被装进UDP头`，而`UDP头会和原始数据包合并组成新的UDP数据包`。
* UDP头中具有目标端口，源端口等信息。
* 添加了UDP协议之后，网络传输模型可以写成下面的样子:

    
* `虽然UDP协议可以校验数据是否正确，但是不提供重发机制，只会丢弃当前错误的数据包`
* `UDP协议的优点就是传输速度快，缺点就是不能保证数据可靠性`
* 所以UDP协议一般用在不严格要求数据完整性，但是严格要求速度的场景，例如`在线游戏，在线直播(丢包了也没事，还可以继续看)等`

#### 3. TCP协议:把数据完整地送达应用程序
* `在浏览器请求，收发邮件等情境中不能使用UDP协议，因为要求数据传输的可靠性`
* 在这种时候，我们就要使用TCP协议。
* `TCP协议(Transmission Control Protocol传输控制协议)是一种面向连接的，可靠的，基于字节流的传输层通信协议`
* 相对于UDP协议，TCP协议有以下特点:
1. `针对数据包丢失情况，TCP会提供重传机制`
2. `TCP引入了数据包排序机制，可以用来保证数据包能够组合成一个完整的文件`
    
* TCP协议同样有一个TCP头，`TCP头包括目标端口，源端口还有数据包的序列号`
* TCP协议的传输模型如下所示:
     
* 一个完整的TCP连接的生命周期包括了`建立连接，传输数据，断开连接`三个阶段
1. 建立连接
* TCP协议通过三握手来建立客户端和服务器之间的连接。
* 前置知识:SYN表示请求连接,ACK表示确认连接,FIN表示释放连接
* 三握手的过程如图所示:


1.1 请求连接SYN
* 首先客户端发送SYN请求建立连接的报文
1.2 SYN+ACK
* 服务器端接收到SYN请求，所以返回ACK报文,`表示服务器能够接收到客户端的请求`
* 并且需要请求和客户端建立连接，所以还需要SYN报文
* 加起来就是SYN+ACK报文
1.3 ACK
* 客户端接收到SYN+ACK报文，`其中ACK表示客户端知道自己之前的报文发送成功了`
* 然后客户端发送ACK报文，`服务器端接收到ACK报文表示知道自己之前的报文发送成功了`
* 经过三次握手，双方都知道彼此可以接收到报文，也就连接成功了！

2. 传输数据
* 在该阶段，`接收端需要对每个数据包进行确认操作，也就是接收端在接收到数据包之后，需要发送确认数据包给发送端`
* `所以当发送端发送了一个数据包之后，在规定时间内没有接收到接收端反馈的确认消息，则判断为数据包丢失，并触发发送端的重发机制`
* `同样，一个大的文件在传输过程中会被拆分成很多小的数据包，这些数据包到达接收端后，接收端会按照 TCP 头中的序号为其排序，从而保证组成完整的数据`

3. 断开连接
* 数据传输完毕之后，就需要断开连接了，断开连接需要确保双方都能断开
* 断开连接使用的是四次挥手,四次挥手的过程如图所示:

3.1 FIN请求断开连接
* 客户端向服务器端发送FIN报文，请求断开连接
3.2 针对FIN的ACK确认应答
* 服务器收到客户端的FIN报文，发送ACK报文给客户端，`表示已经收到客户端的断开连接请求报文`
* 发送完ACK确认报文之后，服务器端这个时候还是可以和客户端进行数据传输的
3.3 FIN请求切断连接
* 服务器端发送完数据之后，觉得可以断开连接了，就向客户端发送FIN报文，`表示服务器也要关闭连接了`
3.4 针对FIN的确认ACK应答
* 客户端接收到FIN报文之后会发送一个ACK报文给服务器，`告诉服务器可以关闭连接了`

